<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="DotCalc.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Калькулятор"
    BackgroundColor="#F3F3F3">

    <!--  Локальные стили этой страницы: кнопки, вкладки и элементы списков.  -->
    <ContentPage.Resources>
        <!--  Кнопки с цифрами (0–9 и десятичный разделитель).  -->
        <Style x:Key="NumberButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#FAFAFA" />
            <Setter Property="TextColor" Value="#1E1E1E" />
            <Setter Property="FontSize" Value="22" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <!--  Операторы (+, −, ×, ÷).  -->
        <Style x:Key="OperatorButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#F9F9F9" />
            <Setter Property="TextColor" Value="#1E1E1E" />
            <Setter Property="FontSize" Value="18" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <!--  Функциональные кнопки (C/CE/%, √, 1/x и т.п.).  -->
        <Style x:Key="FunctionButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#F0F0F0" />
            <Setter Property="TextColor" Value="#1E1E1E" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <!--  Верхний ряд кнопок памяти (MC/MR/M+/M-/MS).  -->
        <Style x:Key="MemoryButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="Transparent" />
            <Setter Property="TextColor" Value="#6E6E6E" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Margin" Value="1" />
        </Style>

        <!--  Кнопка "=" выделена отдельным стилем.  -->
        <Style x:Key="EqualsButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#0078D4" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="22" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <!--  Кнопки вкладок "Журнал"/"Память".  -->
        <Style x:Key="TabButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="Transparent" />
            <Setter Property="TextColor" Value="#6E6E6E" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Padding" Value="12,8" />
        </Style>

        <!--  Активная вкладка — более контрастный текст и жирное начертание.  -->
        <Style x:Key="TabButtonActiveStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="Transparent" />
            <Setter Property="TextColor" Value="#1E1E1E" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Padding" Value="12,8" />
        </Style>

        <!--  Кнопки действий на отдельном элементе памяти (показываются при наведении).  -->
        <Style x:Key="MemoryItemButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#E0E0E0" />
            <Setter Property="TextColor" Value="#1E1E1E" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="CornerRadius" Value="2" />
            <Setter Property="BorderWidth" Value="0" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="HeightRequest" Value="28" />
            <Setter Property="MinimumWidthRequest" Value="36" />
        </Style>
    </ContentPage.Resources>

    <!--  Основная разметка: слева калькулятор, справа боковая панель (история/память).  -->
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!--  Calculator Panel  -->
        <Grid
            Grid.Column="0"
            Padding="8"
            ColumnSpacing="2"
            RowSpacing="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="80" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Expression Display  -->
            <Label
                x:Name="ExpressionLabel"
                Grid.Row="0"
                Padding="10,5"
                FontSize="16"
                HorizontalTextAlignment="End"
                Text=""
                TextColor="#6E6E6E" />

            <!--  Main Display  -->
            <Label
                x:Name="DisplayLabel"
                Grid.Row="2"
                Padding="10,5"
                FontAttributes="Bold"
                FontSize="48"
                HorizontalTextAlignment="End"
                LineBreakMode="TailTruncation"
                Text="0"
                TextColor="#1E1E1E"
                VerticalTextAlignment="End" />

            <!--  Memory Buttons Row  -->
            <Grid
                Grid.Row="3"
                Margin="0,10,0,5"
                ColumnSpacing="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Button
                    Grid.Column="0"
                    Clicked="OnMemoryClear"
                    Style="{StaticResource MemoryButtonStyle}"
                    Text="MC" />
                <Button
                    Grid.Column="1"
                    Clicked="OnMemoryRecall"
                    Style="{StaticResource MemoryButtonStyle}"
                    Text="MR" />
                <Button
                    Grid.Column="2"
                    Clicked="OnMemoryAdd"
                    Style="{StaticResource MemoryButtonStyle}"
                    Text="M+" />
                <Button
                    Grid.Column="3"
                    Clicked="OnMemorySubtract"
                    Style="{StaticResource MemoryButtonStyle}"
                    Text="M-" />
                <Button
                    Grid.Column="4"
                    Clicked="OnMemoryStore"
                    Style="{StaticResource MemoryButtonStyle}"
                    Text="MS" />
            </Grid>

            <!--  Calculator Buttons Grid  -->
            <Grid
                Grid.Row="4"
                ColumnSpacing="2"
                RowSpacing="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!--  Row 0: %, CE, C, Backspace  -->
                <Button
                    Grid.Row="0"
                    Grid.Column="0"
                    Clicked="OnPercent"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="%" />
                <Button
                    Grid.Row="0"
                    Grid.Column="1"
                    Clicked="OnClearEntry"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="CE" />
                <Button
                    Grid.Row="0"
                    Grid.Column="2"
                    Clicked="OnClear"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="C" />
                <Button
                    Grid.Row="0"
                    Grid.Column="3"
                    Clicked="OnBackspace"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="⌫" />

                <!--  Row 1: 1/x, x², √x, ÷  -->
                <Button
                    Grid.Row="1"
                    Grid.Column="0"
                    Clicked="OnInverse"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="⅟𝑥" />
                <Button
                    Grid.Row="1"
                    Grid.Column="1"
                    Clicked="OnSquare"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="𝑥²" />
                <Button
                    Grid.Row="1"
                    Grid.Column="2"
                    Clicked="OnSquareRoot"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="²√𝑥" />
                <Button
                    Grid.Row="1"
                    Grid.Column="3"
                    Clicked="OnOperator"
                    Style="{StaticResource OperatorButtonStyle}"
                    Text="÷" />

                <!--  Row 2: 7, 8, 9, ×  -->
                <Button
                    Grid.Row="2"
                    Grid.Column="0"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="7" />
                <Button
                    Grid.Row="2"
                    Grid.Column="1"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="8" />
                <Button
                    Grid.Row="2"
                    Grid.Column="2"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="9" />
                <Button
                    Grid.Row="2"
                    Grid.Column="3"
                    Clicked="OnOperator"
                    Style="{StaticResource OperatorButtonStyle}"
                    Text="×" />

                <!--  Row 3: 4, 5, 6, -  -->
                <Button
                    Grid.Row="3"
                    Grid.Column="0"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="4" />
                <Button
                    Grid.Row="3"
                    Grid.Column="1"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="5" />
                <Button
                    Grid.Row="3"
                    Grid.Column="2"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="6" />
                <Button
                    Grid.Row="3"
                    Grid.Column="3"
                    Clicked="OnOperator"
                    Style="{StaticResource OperatorButtonStyle}"
                    Text="−" />

                <!--  Row 4: 1, 2, 3, +  -->
                <Button
                    Grid.Row="4"
                    Grid.Column="0"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="1" />
                <Button
                    Grid.Row="4"
                    Grid.Column="1"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="2" />
                <Button
                    Grid.Row="4"
                    Grid.Column="2"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="3" />
                <Button
                    Grid.Row="4"
                    Grid.Column="3"
                    Clicked="OnOperator"
                    Style="{StaticResource OperatorButtonStyle}"
                    Text="+" />

                <!--  Row 5: +/-, 0, ,, =  -->
                <Button
                    Grid.Row="5"
                    Grid.Column="0"
                    Clicked="OnNegate"
                    Style="{StaticResource FunctionButtonStyle}"
                    Text="+/−" />
                <Button
                    Grid.Row="5"
                    Grid.Column="1"
                    Clicked="OnDigit"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="0" />
                <Button
                    Grid.Row="5"
                    Grid.Column="2"
                    Clicked="OnDecimal"
                    Style="{StaticResource NumberButtonStyle}"
                    Text="," />
                <Button
                    Grid.Row="5"
                    Grid.Column="3"
                    Clicked="OnEquals"
                    Style="{StaticResource EqualsButtonStyle}"
                    Text="=" />
            </Grid>
        </Grid>

        <!--  History/Memory Panel  -->
        <Border
            Grid.Column="1"
            BackgroundColor="#FAFAFA"
            StrokeThickness="0"
            WidthRequest="220">
            <Grid RowDefinitions="Auto,*,Auto">
                <!--  Tab Header  -->
                <Grid
                    Grid.Row="0"
                    Padding="4,4,4,0"
                    ColumnDefinitions="*,*">
                    <Button
                        x:Name="HistoryTabButton"
                        Grid.Column="0"
                        Clicked="OnHistoryTabClicked"
                        Style="{StaticResource TabButtonActiveStyle}"
                        Text="Журнал" />
                    <Button
                        x:Name="MemoryTabButton"
                        Grid.Column="1"
                        Clicked="OnMemoryTabClicked"
                        Style="{StaticResource TabButtonStyle}"
                        Text="Память" />
                </Grid>

                <!--  Tab Indicator  -->
                <BoxView
                    x:Name="HistoryTabIndicator"
                    Grid.Row="0"
                    Margin="0,0,0,0"
                    HeightRequest="2"
                    HorizontalOptions="Start"
                    VerticalOptions="End"
                    WidthRequest="110"
                    Color="#0078D4" />

                <!--  History Content  -->
                <Grid
                    x:Name="HistoryContent"
                    Grid.Row="1"
                    IsVisible="True">
                    <CollectionView
                        x:Name="HistoryCollectionView"
                        ItemsSource="{Binding History}"
                        SelectionChanged="OnHistoryItemSelected"
                        SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <VerticalStackLayout Padding="12,8">
                                    <Label
                                        FontSize="13"
                                        LineBreakMode="TailTruncation"
                                        Text="{Binding Expression}"
                                        TextColor="#6E6E6E" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="18"
                                        LineBreakMode="TailTruncation"
                                        Text="{Binding Result}"
                                        TextColor="#1E1E1E" />
                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <Grid HorizontalOptions="Fill" VerticalOptions="Fill">
                                <Label
                                    FontSize="14"
                                    HorizontalOptions="Center"
                                    HorizontalTextAlignment="Center"
                                    Text="История пуста"
                                    TextColor="#9E9E9E"
                                    VerticalOptions="Center" />
                            </Grid>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </Grid>

                <!--  Memory Content  -->
                <Grid
                    x:Name="MemoryContent"
                    Grid.Row="1"
                    IsVisible="False">
                    <CollectionView
                        x:Name="MemoryCollectionView"
                        ItemsSource="{Binding MemoryList}"
                        SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="12,8">
                                    <Grid.GestureRecognizers>
                                        <PointerGestureRecognizer PointerEntered="OnMemoryItemPointerEntered" PointerExited="OnMemoryItemPointerExited" />
                                        <TapGestureRecognizer CommandParameter="{Binding .}" Tapped="OnMemoryItemTapped" />
                                    </Grid.GestureRecognizers>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <!--  Memory Value  -->
                                    <Label
                                        Grid.Row="0"
                                        FontAttributes="Bold"
                                        FontSize="20"
                                        LineBreakMode="TailTruncation"
                                        Text="{Binding DisplayValue}"
                                        TextColor="#1E1E1E" />

                                    <!--  Action Buttons (shown on hover)  -->
                                    <HorizontalStackLayout
                                        Grid.Row="1"
                                        Margin="0,4,0,0"
                                        IsVisible="{Binding IsHovered}"
                                        Spacing="4">
                                        <Button
                                            Clicked="OnMemoryItemClear"
                                            Style="{StaticResource MemoryItemButtonStyle}"
                                            Text="MC" />
                                        <Button
                                            Clicked="OnMemoryItemAdd"
                                            Style="{StaticResource MemoryItemButtonStyle}"
                                            Text="M+" />
                                        <Button
                                            Clicked="OnMemoryItemSubtract"
                                            Style="{StaticResource MemoryItemButtonStyle}"
                                            Text="M-" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <Grid HorizontalOptions="Fill" VerticalOptions="Fill">
                                <Label
                                    FontSize="14"
                                    HorizontalOptions="Center"
                                    HorizontalTextAlignment="Center"
                                    Text="В памяти ничего нет"
                                    TextColor="#9E9E9E"
                                    VerticalOptions="Center" />
                            </Grid>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </Grid>

                <!--  Clear Button (changes based on active tab)  -->
                <Button
                    x:Name="ClearPanelButton"
                    Grid.Row="2"
                    Margin="10"
                    BackgroundColor="Transparent"
                    Clicked="OnClearPanel"
                    FontSize="14"
                    Text="🗑 Очистить журнал"
                    TextColor="#6E6E6E" />
            </Grid>
        </Border>
    </Grid>

</ContentPage>
